<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cherrubi Admin Panel</title>
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;700&display=swap" rel="stylesheet">
<style>
body { background: linear-gradient(135deg, #fdf2f8, #fce7f3); min-height: 100vh; padding: 20px; font-family: 'Outfit', sans-serif;}
.admin-container { max-width: 800px; margin: 0 auto; background: white; border-radius: 20px; padding: 30px; box-shadow: 0 10px 30px rgba(255, 105, 180, 0.1); }
.section { margin-bottom: 30px; padding: 20px; border: 2px dashed #f8c8dc; border-radius: 12px; }
.section h3 { color: #d45d8b; margin-bottom: 15px; font-size: 1.2rem; }
button { background: #ff99c8; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; transition: background 0.2s; }
button:hover { background: #ff6b9d; }
input[type="number"], input[type="email"] { padding: 8px; border: 1px solid #f8c8dc; border-radius: 6px; width: 100%; max-width: 250px; }
.hidden { display: none; }
#googleLoginBtn { background:#4285F4;color:white;margin-top:10px; }
.status-msg { margin-top: 10px; padding: 10px; border-radius: 6px; font-weight: 600; }
.status-success { background: #d4edda; color: #155724; }
.status-error { background: #f8d7da; color: #721c24; }
</style>
</head>
<body>

<!-- LOGIN BOX -->
<div id="login-box">
  <h2>Admin Login</h2>
  <button id="googleLoginBtn">Sign in with Google</button>
  <p id="loginStatus"></p>
</div>

<!-- ADMIN PANEL -->
<div id="admin-panel" class="hidden">
  <h1>‚Çç^. .^‚Çé‚üÜ Cherrubi Admin Panel</h1>
  <button id="logoutBtn">Logout</button>

  <div class="admin-container">
    <!-- Shop Status -->
    <div class="section">
      <h3>üõí Shop & Commissions Status</h3>
      <label>Shop Open: <input type="checkbox" id="siteOpenToggle"></label>
      <br><br>
      <button id="toggleShopBtn">Save Changes</button>
      <p id="statusMsg"></p>
    </div>

    <!-- Slots Management -->
    <div class="section">
      <h3>üéØ Slots Management</h3>
      <label>Filled Slots: <input type="number" id="filledSlotsInput" min="0" max="7"></label>
      <br><br>
      <button id="clearSlotsBtn">Clear All Slots</button>
      <button id="updateSlotsBtn">Update Slots</button>
      <p id="slotsMsg"></p>
    </div>

    <!-- Product Stock -->
    <div class="section">
      <h3>üì¶ Individual Product Stock</h3>
      <p>Check to mark as "Out of Stock".</p>
      <label><input type="checkbox" id="mlp-soloStock"> MLP OC</label><br>
      <label><input type="checkbox" id="animationStock"> Simple Looped Animation</label><br>
      <label><input type="checkbox" id="cardsStock"> Character Card</label><br>
      <label><input type="checkbox" id="mysteryStock"> Mystery Pair Event</label><br>
      <label><input type="checkbox" id="chibiStock"> Chibi Portrait</label><br>
      <label><input type="checkbox" id="petStock"> Pet Portrait</label><br>
      <br>
      <button id="updateStockBtn">Save Stock Changes</button>
      <p id="stockMsg"></p>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
import { getFirestore, doc, getDoc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCNKl48MGYe7LdfnE2-3dXBzbTDEtHQuzs",
  authDomain: "artcommissions-fd346.firebaseapp.com",
  projectId: "artcommissions-fd346",
  storageBucket: "artcommissions-fd346.firebasestorage.app",
  messagingSenderId: "603500082233",
  appId: "1:603500082233:web:05901544a951ab2cf4c9e8"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const provider = new GoogleAuthProvider();

const loginBox = document.getElementById("login-box");
const panel = document.getElementById("admin-panel");
const loginStatus = document.getElementById("loginStatus");
const logoutBtn = document.getElementById("logoutBtn");
const googleBtn = document.getElementById("googleLoginBtn");

const shopDoc = doc(db, "shop", "global");
const PRODUCTS = ['mlp-solo','trio','animation','cards','mystery','chibi','pet'];

// Helper function to show status messages
function showStatus(elementId, message, isSuccess = true) {
  const el = document.getElementById(elementId);
  el.textContent = message;
  el.className = isSuccess ? 'status-msg status-success' : 'status-msg status-error';
  setTimeout(() => {
    el.textContent = '';
    el.className = '';
  }, 3000);
}

// Add console logging for debugging
function logError(context, error) {
  console.error(`[${context}]`, error);
  console.error('Error details:', {
    message: error.message,
    code: error.code,
    stack: error.stack
  });
}

// Google login
googleBtn.addEventListener("click", async ()=>{
  try { 
    await signInWithPopup(auth, provider); 
    loginStatus.textContent="‚úÖ Logged in!"; 
  }
  catch(err){ 
    loginStatus.textContent="‚ùå "+err.message; 
  }
});

// Logout
logoutBtn.addEventListener("click", ()=>signOut(auth));

// Observe auth state
onAuthStateChanged(auth, async (user)=>{
  if(user){
    loginBox.style.display="none";
    panel.classList.remove("hidden");
    await ensureDoc();
    startRealtimeListener();
  } else {
    loginBox.style.display="block";
    panel.classList.add("hidden");
  }
});

// Ensure Firestore doc exists
async function ensureDoc(){
  const snap = await getDoc(shopDoc);
  if(!snap.exists()){
    await setDoc(shopDoc, { siteOpen:true, filledSlots:0, disabledProducts:[] });
  }
}

// Load state into UI
function updateUI(data){
  document.getElementById('siteOpenToggle').checked = data.siteOpen ?? true;
  document.getElementById('filledSlotsInput').value = data.filledSlots ?? 0;
  PRODUCTS.forEach(id=>{
    const cb = document.getElementById(id+'Stock');
    if(cb) cb.checked = data.disabledProducts?.includes(id) ?? false;
  });
}

// Realtime listener
function startRealtimeListener(){
  onSnapshot(shopDoc, snap=>{
    if(snap.exists()){
      updateUI(snap.data());
    }
  });
}

// Button event listeners (instead of onclick attributes)
document.getElementById('toggleShopBtn').addEventListener('click', async ()=>{
  console.log('Toggle shop button clicked');
  try {
    const isOpen = document.getElementById('siteOpenToggle').checked;
    console.log('Setting siteOpen to:', isOpen);
    console.log('Writing to path: shop/global');
    
    await setDoc(shopDoc, { siteOpen: isOpen }, { merge:true });
    console.log('‚úÖ Successfully updated shop status');
    showStatus('statusMsg', `‚úÖ Shop ${isOpen ? 'opened' : 'closed'} successfully!`);
  } catch(err) {
    logError('toggleShop', err);
    showStatus('statusMsg', `‚ùå Error: ${err.message}`, false);
  }
});

document.getElementById('updateSlotsBtn').addEventListener('click', async ()=>{
  console.log('Update slots button clicked');
  try {
    const slots = parseInt(document.getElementById('filledSlotsInput').value);
    console.log('Setting slots to:', slots);
    
    if(slots>=0 && slots<=7){
      await setDoc(shopDoc, { filledSlots:slots }, { merge:true });
      console.log('‚úÖ Successfully updated slots');
      showStatus('slotsMsg', `‚úÖ Slots updated to ${slots}/7`);
    } else {
      showStatus('slotsMsg', '‚ùå Slots must be 0-7', false);
    }
  } catch(err) {
    logError('updateSlots', err);
    showStatus('slotsMsg', `‚ùå Error: ${err.message}`, false);
  }
});

document.getElementById('clearSlotsBtn').addEventListener('click', async ()=>{
  console.log('Clear slots button clicked');
  try {
    await setDoc(shopDoc, { filledSlots:0 }, { merge:true });
    document.getElementById('filledSlotsInput').value=0;
    console.log('‚úÖ Successfully cleared slots');
    showStatus('slotsMsg', '‚úÖ All slots cleared!');
  } catch(err) {
    logError('clearSlots', err);
    showStatus('slotsMsg', `‚ùå Error: ${err.message}`, false);
  }
});

document.getElementById('updateStockBtn').addEventListener('click', async ()=>{
  console.log('Update stock button clicked');
  try {
    const disabled = [];
    PRODUCTS.forEach(id=>{
      const cb = document.getElementById(id+'Stock');
      if(cb && cb.checked) disabled.push(id);
    });
    console.log('Setting disabledProducts to:', disabled);
    
    await setDoc(shopDoc, { disabledProducts:disabled }, { merge:true });
    console.log('‚úÖ Successfully updated product stock');
    showStatus('stockMsg', `‚úÖ Product stock updated! ${disabled.length} items out of stock`);
  } catch(err) {
    logError('updateStock', err);
    showStatus('stockMsg', `‚ùå Error: ${err.message}`, false);
  }
});
</script>

</body>
</html>